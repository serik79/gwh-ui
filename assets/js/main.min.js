"use strict";function asyncGeneratorStep(e,t,s,n,a,o,i){try{var r=e[o](i),l=r.value}catch(e){return void s(e)}r.done?t(l):Promise.resolve(l).then(n,a)}function _asyncToGenerator(e){return function(){var t=this,s=arguments;return new Promise((function(n,a){var o=e.apply(t,s);function i(e){asyncGeneratorStep(o,n,a,i,r,"next",e)}function r(e){asyncGeneratorStep(o,n,a,i,r,"throw",e)}i(void 0)}))}}function ownKeys(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function _objectSpread(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?ownKeys(Object(s),!0).forEach((function(t){_defineProperty(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):ownKeys(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}function _defineProperty(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}import{SUBSETS_PANGRAMS,RTL_SUBSETS,WEIGHT_NAME,VARIANTS_EXPLICATION}from"./modules/constants.min.js";import{reloadPage,getFetchResponse,setLoader,sortVariants}from"./modules/helpers.min.js";import{IndDB}from"./modules/indexeddb.min.js";class GWHelper{constructor(e){_defineProperty(this,"open_db_options",{upgrade:(e,t)=>{var s=e.target.result;if(s.onerror=e=>console.error('ERROR IN "REQUEST_DB.onupgradeneeded": ',e.target.error||e),e.oldVersion<1){var n=s.createObjectStore(this.options.available_fonts_store_name,{keyPath:"id"});n.createIndex("family","family",{unique:!0}),n.createIndex("subsets","subsets",{unique:!1,multiEntry:!0}),n.createIndex("category","category",{unique:!1}),(n=s.createObjectStore(this.options.downloaded_fonts_store_name,{keyPath:"id"})).createIndex("variants","variants",{unique:!1,multiEntry:!0})}},success:e=>{var t=e.target.result;return t.onerror=e=>console.error('ERROR IN "REQUEST_DB.onsuccess": ',e.target.error||e),t.onversionchange=()=>{t.close(),console.warn("%cThe database is out of date ðŸ‘´ please reload the page.","color:red;font-size:30px"),reloadPage()},t}}),this.options={available_fonts_store_name:"available_fonts",downloaded_fonts_store_name:"downloaded_fonts",db_name:"fontsDB",db_version:1},Object.assign(this.options,e),this.init()}init(){this.indDB=new IndDB((e=>{var{db_name:t,db_version:s}=e;return{db_name:t,db_version:s}})(this.options)),this.open_btn=document.querySelector(this.options.open_btn||"#GWH_open_btn"),this.delete_btn=document.querySelector(this.options.delete_btn||"#GWH_delete_btn");var e=(t,s)=>{setLoader(),this[t+"_btn"].setAttribute("disabled","disabled"),this[s+"_btn"].addEventListener("click",(()=>{this.indDB[s](this.open_db_options).then((n=>{e(s,t),console.info(n)})).catch((e=>{console.error(e.message)}))}),{once:!0}),this[s+"_btn"].removeAttribute("disabled"),this._initAction(t)};indexedDB.databases().then((t=>{e("delete","open"),t.filter((e=>e.name===this.options.db_name&&e.version===this.options.db_version)).length&&this.open_btn.dispatchEvent(new Event("click"))}))}_initAction(e){if(this._findVariables(),this._findElements(),"open"===e){var t=e=>{this._createAvailableFontsList().then((e=>{this._attachEvents(e),this._createDownloadedFontsList(e).then((e=>{console.log(e)}))})).finally(setLoader(!1))},s=this.indDB._transaction([this.options.available_fonts_store_name,this.options.downloaded_fonts_store_name]);s.objectStore(this.options.available_fonts_store_name).count().onsuccess=e=>{if(e.target.result)t();else{var s=e=>{this.indDB.setStoreData([this.options.available_fonts_store_name],[e]).then((e=>{t()})).catch((e=>console.error(e)))};getFetchResponse({action:"get_font"}).then((e=>s(e)))}},s.objectStore(this.options.downloaded_fonts_store_name).count().onsuccess=e=>{e.target.result}}else"delete"===e&&(this.search_fieldset.setAttribute("disabled","disabled"),this.available_fonts_list_items=this.search_input.value=null,this.available_fonts_list.innerHTML=this.count_items.innerHTML="",this.main_holder.setAttribute("hidden",""),setLoader(!1))}_findVariables(){this.GWH_url="https://google-webfonts-helper.herokuapp.com/api/fonts",this.font_detalis_id_prefix=this.options.font_detalis_id_prefix||"GWH_font_details_",this.fonts_path=this.options.fonts_path||"/assets/fonts/"}_findElements(){this.search_form=document.querySelector(this.options.search_form||"#GWH_search_form"),this.search_fieldset=document.querySelector(this.options.search_fieldset||"#GWH_search_fieldset"),this.search_input=document.querySelector(this.options.search_input||"#GWH_search_input"),this.subset_select=document.querySelector(this.options.subset_select||"#GWH_subset_select"),this.category_select=document.querySelector(this.options.category_select||"#GWH_category_select"),this.count_items=document.querySelector(this.options.count_items||"#GWH_count_items"),this.main_holder=document.querySelector(this.options.main_holder||"#GWH_main_holder"),this.available_fonts_list=document.querySelector(this.options.available_fonts_list||"#GWH_available_fonts_list"),this.downloaded_fonts_list=document.querySelector(this.options.downloaded_fonts_list||"#GWH_downloaded_fonts_list")}_createAvailableFontsList(){var e=new IntersectionObserver(((e,t)=>{e.forEach((e=>{e.isIntersecting&&(document.head.insertAdjacentHTML("beforeend",'<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family='.concat(e.target.dataset.query,'">')),t.unobserve(e.target))}))}),{rootMargin:"100% 0px 100% 0px"}),t=new Set,s=new Set,n=t=>{var n=(e=>{var t="";return 1===e.variants.length&&"regular"!==e.defVariant?t="italic"===e.defVariant?":ital,wght@1,400":":wght@"+e.defVariant:e.variants.includes("regular")||(t=":wght@"+e.defVariant),t})(t),a=(e=>{var t="";return e.subsets.forEach((e=>{s.add(e);var n="alert-text";SUBSETS_PANGRAMS[e]&&(n=e,RTL_SUBSETS.includes(e)&&(n+=" rtl")),t+='<p class="'.concat(n,'">').concat(SUBSETS_PANGRAMS[e]||"no pangram for this language","</p>")})),t})(t),o=document.createElement("a");o.className="font-summary",o.href="#"+this.font_detalis_id_prefix+t.id,o.innerHTML='<h3 class="title">"'.concat(t.family,'"</h3>').concat(a);var i=document.createElement("div");i.className="font-details",i.id=this.font_detalis_id_prefix+t.id,i.setAttribute("hidden","");var r=document.createElement("li");return r.style.fontFamily="'".concat(t.family,"'"),r.dataset.query=t.family.split(" ").join("+")+n+"&display=swap",r.dataset.id=t.id,r.append(o,i),e.observe(r),r};return document.head.insertAdjacentHTML("beforeend",'<link rel="preconnect" href="https://fonts.gstatic.com">'),new Promise((e=>{var a={},o=this.options.available_fonts_store_name;this.indDB._transaction(o).objectStore(o).openCursor().onsuccess=o=>{var i=o.target.result;if(i){var r=i.value;t.add(r.category),a[r.id]=n(r),i.continue()}else e([a,s,t])}}))}_attachEvents(e){var[t,s,n]=e,a="subset-";this.available_fonts_list_items=t,this.search_fieldset.removeAttribute("disabled"),this.main_holder.removeAttribute("hidden");var o=[...n].sort(((e,t)=>e.localeCompare(t))).map((e=>new Option(e,e))).reverse();this.category_select.append(...o);var i=[...s].sort(((e,t)=>e.localeCompare(t))).map((e=>new Option(e,e)));this.subset_select.append(...i);var r=e=>{var t=(e,t)=>{!e&&this.search_input.value&&(e=this.search_input.value),this.available_fonts_list.innerHTML=this.count_items.innerHTML="";var s=document.createDocumentFragment(),n=t.filter((t=>t.family.toLowerCase().includes(e.toLowerCase())));this.count_items.append(n.length),n.forEach((e=>{s.appendChild(this.available_fonts_list_items[e.id])})),this.available_fonts_list.append(s),setLoader(!1)};t("",e),["focus","input"].forEach((s=>this.search_input.addEventListener(s,(s=>{t(s.target.value,e)}),!1)))};this.indDB.getAllData({store:this.options.available_fonts_store_name}).then((e=>r(e))),this.subset_select.onchange=e=>{this.indDB.getAllData({store:this.options.available_fonts_store_name,condition:!!e.target.selectedIndex,index:"subsets",value:e.target.selectedIndex?e.target.value:null}).then((t=>{[...this.available_fonts_list.classList].forEach((e=>{e.startsWith(a)&&this.available_fonts_list.classList.remove(e)})),e.target.selectedIndex&&this.available_fonts_list.classList.add(a+e.target.value),this.category_select.selectedIndex&&(t=t.filter((e=>e.category===this.category_select.value))),r(t),Object.values(this.available_fonts_list_items).forEach((e=>{e.classList.contains("has-details")&&(e.classList.remove("has-details","active"),e.querySelector(".font-details").innerHTML="")}))}))},this.category_select.onchange=e=>{this.indDB.getAllData({store:this.options.available_fonts_store_name,condition:!!e.target.selectedIndex,index:"category",value:e.target.selectedIndex?e.target.value:null}).then((e=>{this.subset_select.selectedIndex&&(e=e.filter((e=>e.subsets.includes(this.subset_select.value)))),r(e)}))},this.search_form.onreset=()=>{setLoader(),[...this.available_fonts_list.classList].forEach((e=>{e.startsWith(a)&&this.available_fonts_list.classList.remove(e)})),this.indDB.getAllData({store:this.options.available_fonts_store_name}).then((e=>r(e)))},this.available_fonts_list.onclick=e=>{var t=e.target.closest("a");t&&(e.preventDefault(),this._createFontFamily(t))}}_createFontFamily(e){var t=this,s=e.parentElement,n=s.dataset.id,a=s.querySelector(e.getAttribute("href")),o=e=>e.subsets.map((t=>{var s=document.createElement("input");s.type="checkbox",s.value=t,t!==e.defSubset&&t!==this.subset_select.value||s.setAttribute("checked","");var n=document.createElement("label");return n.innerText=t,n.prepend(s),n})),i=(e,t,s)=>{var n=document.createElement("li");n.className="variation-holder",Object.assign(n.style,_objectSpread({},VARIANTS_EXPLICATION[t]));var a=document.createElement("a");a.style.color="green",a.href="".concat(this.GWH_url+"/"+e.id,"?download=zip&variants=").concat(t,"&formats=woff2"),a.innerText="download",a.className="variation-download-link",a.setAttribute("download",""),a.onclick=n=>{n.preventDefault(),n.stopPropagation(),setLoader(),this._downloadFont(e,t,s,n).then((e=>{this._createDownloadedFontsList(e).then((e=>{console.log(e)}))})).catch((e=>console.error(e))).finally((()=>{setLoader(!1)}))};var o=document.createElement("h4");o.className="variation-title",o.innerText=WEIGHT_NAME[VARIANTS_EXPLICATION[t].fontWeight]+(VARIANTS_EXPLICATION[t].fontStyle?" "+VARIANTS_EXPLICATION[t].fontStyle:"")+" . . . . . ",o.appendChild(a);var i=e.defSubset;this.subset_select.selectedIndex&&(i=this.subset_select.value);var r=document.createElement("p");return r.innerText=SUBSETS_PANGRAMS[i],r.className="variation-subset-text",RTL_SUBSETS.some((e=>e===i))&&(r.className="rtl"),n.append(o,r),n};Promise.resolve().then(_asyncToGenerator((function*(){s.classList.contains("has-details")||(yield t.indDB.getAllData({store:t.options.available_fonts_store_name,value:n}).then((e=>{var[t]=e;a.innerHTML="",a.appendChild((e=>{var t,s,n=document.createDocumentFragment(),a=document.createElement("ul"),r=o(e);return sortVariants(e.variants).forEach((t=>{a.appendChild(i(e,t,r))})),n.append((t=r,(s=document.createElement("div")).className="subsets-holder",s.innerHTML='<h4 class="subsets-title">Subsets</h4>',s.append(...t),s),a),n})(t)),s.classList.contains("foreign-css-downloaded")||document.head.insertAdjacentHTML("beforeend",(e=>{var t=e.family.split(" ").join("+"),s=[],n=!1;return e.variants.some((e=>e.endsWith("italic")))&&(n=!0,t+=":ital"),e.variants.forEach((e=>{n?s.push((VARIANTS_EXPLICATION[e].fontStyle?"1":"0")+","+VARIANTS_EXPLICATION[e].fontWeight):s.push(VARIANTS_EXPLICATION[e].fontWeight)})),s.length&&(t+=(n?",":":")+"wght@"+s.sort(((e,t)=>e.localeCompare(t))).join(";")),'<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family='.concat(t+="&display=swap",'">')})(t))})))}))).then((()=>{this.available_fonts_list.childNodes.forEach((e=>e.classList.remove("active"))),s.classList.add("active","has-details","foreign-css-downloaded"),window.scroll({top:window.scrollY+s.getBoundingClientRect().top-(document.getElementById("GWH_search_form").offsetHeight+10),left:0,behavior:"smooth"})}))}_downloadFont(e,t,s,n){var a=[].filter.call(s,(e=>e.control.checked)).map((e=>e.control.value)),o=this.options.downloaded_fonts_store_name;a.length&&(n.target.href="".concat(this.GWH_url+"/"+e.id,"?download=zip&subsets=").concat(a.join(","),"&variants=").concat(t,"&formats=woff2"));var i={action:"get_font",font:n.target.getAttribute("href").replace(this.GWH_url+"/",""),info:{family:e.family}},r=(e,t,s)=>this.indDB._transaction(o,{complete:()=>{e(s)},error:e=>{t(e)}},"readwrite").objectStore(o);return new Promise(((s,n)=>{this.indDB._transaction(o).objectStore(o).get(e.id).onsuccess=e=>{var o=e.target.result;if(a.length)if(o)if(t in o.variants){var l=o.variants[t].subsets.split(",");a.length!==l.length||a.filter((e=>!l.includes(e))).length?getFetchResponse({action:"delete_font",font:o.variants[t].files}).then((()=>{getFetchResponse(i).then((e=>{var t=r(s,n,e);Object.assign(o.variants,e.font.variants),t.put(o)}))})):n("The font ".concat(o.family+" "+t," is exists!"))}else getFetchResponse(i).then((e=>{var t=r(s,n,e);Object.assign(o.variants,e.font.variants),t.put(o)}));else getFetchResponse(i).then((e=>{r(s,n,e).add(e.font)}));else n("Chose the subset(s), please!")}}))}_createDownloadedFontsList(){var e=document.createDocumentFragment();return new Promise((t=>{var s=[],n={},a=this.options.downloaded_fonts_store_name;this.indDB._transaction(a).objectStore(a).openCursor().onsuccess=o=>{var i=o.target.result;if(i){var r=i.value,l=Object.keys(r.variants),c=document.createElement("ul");c.className="font-downloaded-details",c.id=this.font_detalis_id_prefix+"_downloaded_"+r.id,c.setAttribute("hidden",""),sortVariants(l).forEach((e=>{var t=r.variants[e].subsets.split(","),n=document.createElement("a");n.className="variation-delete-link",n.innerText="delete",n.title="delete variation",n.href=window.location.origin+this.fonts_path+r.variants[e].files[0],n.onclick=t=>{t.preventDefault(),t.stopPropagation(),getFetchResponse({action:"delete_font",font:r.variants[e].files}).then((t=>{var s=this.indDB._transaction(a,{complete:()=>{this._createDownloadedFontsList(t).then((e=>{console.log(e)}))}},"readwrite").objectStore(a);l.length>1?(delete r.variants[e],s.put(r)):s.delete(r.id)}))};var o=document.createElement("h4");o.className="variation-title",o.innerHTML="".concat(WEIGHT_NAME[VARIANTS_EXPLICATION[e].fontWeight]+(VARIANTS_EXPLICATION[e].fontStyle?" "+VARIANTS_EXPLICATION[e].fontStyle:"")," <small>").concat(t.join("</small>, <small>"),"</small>"),o.appendChild(n);var i=document.createElement("li");Object.assign(i.style,VARIANTS_EXPLICATION[e]),i.className="variation-holder",i.dataset.variant=e,i.appendChild(o),t.forEach((e=>{var t=RTL_SUBSETS.includes(e)?e+" rtl":e;i.insertAdjacentHTML("beforeend",'<p class="'.concat(t,'">').concat(SUBSETS_PANGRAMS[e]||"no pangram for this language","</p>"))})),c.appendChild(i);var d=(e=>{var{fontWeight:t,fontStyle:s="normal"}=e;return{weight:t,style:s}})(VARIANTS_EXPLICATION[e]),h=new FontFace(String(r.family).split(" ").join("-")+"-downloaded","url(".concat(this.fonts_path+r.variants[e].files[0],")"),Object.assign(d,{display:"swap"}));s.push(h)}));var d=l.length>1?" <sup>".concat(l.length,"</sup>"):"",h=document.createElement("a");h.className="family-delete-link",h.innerText="âŒ",h.title="delete family",h.href="#",h.onclick=e=>{e.preventDefault(),e.stopPropagation(),getFetchResponse({action:"delete_font",font:Object.values(r.variants).map((e=>e.files)).flat()}).then((()=>{this.indDB._transaction(a,{complete:e=>{this._createDownloadedFontsList(e).then((e=>{console.log(e)}))}},"readwrite").objectStore(a).delete(r.id)}))};var _=document.createElement("a");_.className="open-close-link",_.href="#"+this.font_detalis_id_prefix+"_downloaded_"+r.id,_.innerHTML="".concat(r.family+d),_.onclick=e=>{e.preventDefault(),e.stopPropagation(),Array.from(this.downloaded_fonts_list.querySelectorAll(".font-downloaded-details")).filter((e=>e!==c)).forEach((e=>{e.setAttribute("hidden","")})),Array.from(this.downloaded_fonts_list.querySelectorAll(".open-close-link")).filter((e=>e!==_)).forEach((e=>e.classList.remove("active"))),c.hasAttribute("hidden")?(c.removeAttribute("hidden"),_.classList.add("active")):(c.setAttribute("hidden",""),_.classList.remove("active"))};var u=document.createElement("h3");u.className="title",u.append(_,h);var f=document.createElement("li");f.style.fontFamily=String(r.family).split(" ").join("-")+"-downloaded",f.dataset.id=r.id,f.append(u,c),e.appendChild(f),i.continue()}else s.forEach((e=>{e.load().then((function(e){document.fonts.add(e)})).catch((function(e){console.error(e)}))})),this.downloaded_fonts_list.innerHTML="",this.downloaded_fonts_list.appendChild(e),t(n)}}))}}window.GWHelper=GWHelper;
//# sourceMappingURL=../maps/main.min.js.map
